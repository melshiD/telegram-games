<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>QueuePilot</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/sortablejs@1.15.6/Sortable.min.js"></script>
    <script src="https://unpkg.com/vue@3"></script>
    <style>
        :root {
            --tg-bg: var(--tg-theme-bg-color, #1a1a2e);
            --tg-text: var(--tg-theme-text-color, #e0e0e0);
            --tg-hint: var(--tg-theme-hint-color, #8e8e93);
            --tg-link: var(--tg-theme-link-color, #3390ec);
            --tg-button: var(--tg-theme-button-color, #3390ec);
            --tg-button-text: var(--tg-theme-button-text-color, #ffffff);
            --tg-secondary-bg: var(--tg-theme-secondary-bg-color, #16213e);
            --tg-section-bg: var(--tg-theme-section-bg-color, #0f3460);
        }

        * { margin: 0; padding: 0; box-sizing: border-box; }

        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
            background: var(--tg-bg);
            color: var(--tg-text);
            min-height: 100vh;
            touch-action: manipulation;
            -webkit-tap-highlight-color: transparent;
            padding-bottom: 72px;
        }

        /* Status chips */
        .chip { display: inline-flex; align-items: center; padding: 2px 10px; border-radius: 12px; font-size: 12px; font-weight: 600; text-transform: uppercase; letter-spacing: 0.5px; }
        .chip-pending { background: rgba(142,142,147,0.2); color: #8e8e93; }
        .chip-in_progress { background: rgba(51,144,236,0.2); color: #3390ec; }
        .chip-done { background: rgba(52,199,89,0.2); color: #34c759; }
        .chip-blocked { background: rgba(255,69,58,0.2); color: #ff453a; }
        .chip-tier-1 { background: rgba(52,199,89,0.15); color: #34c759; }
        .chip-tier-2 { background: rgba(255,159,10,0.15); color: #ff9f0a; }
        .chip-tier-3 { background: rgba(255,69,58,0.15); color: #ff453a; }
        .chip-lg { padding: 4px 14px; font-size: 14px; }

        /* Cards */
        .card {
            background: var(--tg-secondary-bg);
            border-radius: 12px;
            padding: 14px;
            margin-bottom: 10px;
            border: 1px solid rgba(255,255,255,0.06);
            transition: transform 120ms ease, box-shadow 120ms ease;
        }
        .card:active { transform: scale(0.98); }

        /* Sortable ghost */
        .sortable-ghost { opacity: 0.4; }
        .sortable-chosen { box-shadow: 0 8px 24px rgba(0,0,0,0.3); }
        .drag-handle { cursor: grab; touch-action: none; padding: 8px; color: var(--tg-hint); }
        .drag-handle:active { cursor: grabbing; }

        /* Bottom nav */
        .bottom-nav {
            position: fixed; bottom: 0; left: 0; right: 0;
            background: var(--tg-secondary-bg);
            border-top: 1px solid rgba(255,255,255,0.08);
            display: flex; justify-content: space-around; align-items: center;
            height: 64px; padding-bottom: env(safe-area-inset-bottom, 0);
            z-index: 50;
        }
        .nav-item {
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            padding: 6px 16px; border-radius: 8px; min-width: 64px; min-height: 44px;
            color: var(--tg-hint); font-size: 11px; font-weight: 500;
            transition: color 120ms ease; cursor: pointer; background: none; border: none;
        }
        .nav-item.active { color: var(--tg-button); }
        .nav-item svg { width: 24px; height: 24px; margin-bottom: 2px; }

        /* Toast */
        .toast-container {
            position: fixed; top: 16px; left: 16px; right: 16px;
            z-index: 100; display: flex; flex-direction: column; gap: 8px;
            pointer-events: none;
        }
        .toast {
            background: #323248; color: #fff; padding: 12px 16px; border-radius: 10px;
            font-size: 14px; box-shadow: 0 4px 16px rgba(0,0,0,0.3);
            animation: toastIn 250ms ease-out;
            pointer-events: auto;
        }
        .toast-error { border-left: 3px solid #ff453a; }
        .toast-success { border-left: 3px solid #34c759; }
        .toast-info { border-left: 3px solid #3390ec; }

        @keyframes toastIn {
            from { opacity: 0; transform: translateY(-12px); }
            to { opacity: 1; transform: translateY(0); }
        }

        /* Pulse indicator */
        .pulse-dot {
            width: 8px; height: 8px; border-radius: 50%; background: #3390ec;
            display: inline-block; animation: pulse 1.5s infinite;
        }
        @keyframes pulse {
            0%, 100% { opacity: 1; transform: scale(1); }
            50% { opacity: 0.5; transform: scale(1.3); }
        }

        /* Pull to refresh */
        .ptr-indicator {
            text-align: center; padding: 12px; color: var(--tg-hint); font-size: 13px;
            transition: opacity 200ms;
        }

        /* Bleeding badge */
        .badge-bleeding {
            background: rgba(255,69,58,0.15); color: #ff453a;
            padding: 2px 8px; border-radius: 6px; font-size: 11px; font-weight: 700;
            text-transform: uppercase; letter-spacing: 0.5px;
        }

        /* Free tier badge */
        .badge-free {
            background: rgba(52,199,89,0.15); color: #34c759;
            padding: 2px 8px; border-radius: 6px; font-size: 11px; font-weight: 600;
        }

        /* Action buttons */
        .btn {
            min-height: 44px; padding: 10px 20px; border: none; border-radius: 10px;
            font-size: 15px; font-weight: 600; cursor: pointer;
            transition: transform 120ms ease, opacity 120ms ease;
        }
        .btn:active { transform: scale(0.96); }
        .btn-primary { background: var(--tg-button); color: var(--tg-button-text); }
        .btn-danger { background: rgba(255,69,58,0.15); color: #ff453a; }
        .btn-success { background: rgba(52,199,89,0.15); color: #34c759; }
        .btn-warning { background: rgba(255,159,10,0.15); color: #ff9f0a; }
        .btn-secondary { background: rgba(142,142,147,0.15); color: var(--tg-text); }

        /* Form inputs */
        .input-field {
            width: 100%; padding: 12px 14px; border-radius: 10px;
            border: 1px solid rgba(255,255,255,0.1); background: var(--tg-bg);
            color: var(--tg-text); font-size: 15px; outline: none;
            transition: border-color 200ms;
        }
        .input-field:focus { border-color: var(--tg-button); }
        textarea.input-field { resize: vertical; min-height: 100px; }

        /* Scrollable spec */
        .spec-scroll { max-height: 200px; overflow-y: auto; }

        /* Offline banner */
        .offline-banner {
            background: rgba(255,159,10,0.15); color: #ff9f0a;
            text-align: center; padding: 8px; font-size: 13px; font-weight: 500;
        }
    </style>
</head>
<body>
    <div id="app">
        <!-- Offline banner -->
        <div v-if="isOffline" class="offline-banner">Offline — showing cached data</div>

        <!-- Toast overlay -->
        <div class="toast-container">
            <div v-for="t in toasts" :key="t.id" class="toast" :class="'toast-' + t.type">
                {{ t.message }}
            </div>
        </div>

        <!-- ========== SETUP VIEW ========== -->
        <div v-if="currentView === 'setup'" class="p-6 max-w-md mx-auto">
            <div class="text-center mt-12 mb-8">
                <div class="text-4xl mb-3">&#x1F6E0;</div>
                <h1 class="text-2xl font-bold mb-2">QueuePilot</h1>
                <p class="text-sm" style="color: var(--tg-hint)">Enter your GitHub PAT to get started</p>
            </div>
            <div class="mb-4">
                <label class="block text-sm font-medium mb-2" style="color: var(--tg-hint)">Personal Access Token</label>
                <input
                    v-model="patInput"
                    type="password"
                    class="input-field"
                    placeholder="ghp_xxxxxxxxxxxx"
                    @keyup.enter="validateAndSavePat"
                >
            </div>
            <p class="text-xs mb-4" style="color: var(--tg-hint)">
                Needs <code>repo</code> scope. Token stored locally on this device only.
            </p>
            <button class="btn btn-primary w-full" @click="validateAndSavePat" :disabled="patValidating">
                {{ patValidating ? 'Validating...' : 'Connect' }}
            </button>
        </div>

        <!-- ========== DASHBOARD VIEW ========== -->
        <div v-if="currentView === 'dashboard'">
            <!-- Header -->
            <div class="flex items-center justify-between px-4 py-3">
                <div>
                    <h1 class="text-lg font-bold">QueuePilot</h1>
                    <p class="text-xs" style="color: var(--tg-hint)">{{ lastRefreshText }}</p>
                </div>
                <button class="nav-item" @click="navigateTo('settings')" style="padding:4px">
                    <svg fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.066 2.573c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.573 1.066c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.066-2.573c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z"/><circle cx="12" cy="12" r="3"/></svg>
                </button>
            </div>

            <!-- Live status banner -->
            <div v-if="buildingApp" class="mx-4 mb-3 p-3 rounded-xl flex items-center gap-3" style="background: rgba(51,144,236,0.1)">
                <span class="pulse-dot"></span>
                <span class="text-sm font-medium">Kishbrac is building: <strong>{{ buildingApp.title }}</strong></span>
            </div>

            <!-- Pull-to-refresh indicator -->
            <div v-if="ptrPulling" class="ptr-indicator">{{ ptrText }}</div>

            <!-- Sortable card list -->
            <div ref="sortableList" class="px-4 pb-4">
                <div
                    v-for="app in sortedApps"
                    :key="app.id"
                    class="card flex items-start gap-3"
                    :data-id="app.id"
                    @click="openDetail(app)"
                >
                    <div class="drag-handle mt-1" @click.stop>
                        <svg width="16" height="16" viewBox="0 0 16 16" fill="currentColor">
                            <circle cx="5" cy="3" r="1.5"/><circle cx="11" cy="3" r="1.5"/>
                            <circle cx="5" cy="8" r="1.5"/><circle cx="11" cy="8" r="1.5"/>
                            <circle cx="5" cy="13" r="1.5"/><circle cx="11" cy="13" r="1.5"/>
                        </svg>
                    </div>
                    <div class="flex-1 min-w-0">
                        <div class="flex items-center gap-2 mb-1">
                            <span class="text-xs font-bold" style="color: var(--tg-hint)">#{{ app.priority }}</span>
                            <span class="chip" :class="'chip-' + app.status">{{ statusLabel(app.status) }}</span>
                            <span v-if="app.tier" class="chip" :class="'chip-tier-' + app.tier">T{{ app.tier }}</span>
                        </div>
                        <h3 class="text-sm font-semibold truncate">{{ app.title }}</h3>
                        <p class="text-xs mt-1" style="color: var(--tg-hint)">{{ app.price || 'No price set' }}</p>
                    </div>
                    <svg class="mt-2 flex-shrink-0" width="16" height="16" viewBox="0 0 16 16" fill="var(--tg-hint)">
                        <path d="M6 3l5 5-5 5" stroke="currentColor" stroke-width="2" fill="none" stroke-linecap="round"/>
                    </svg>
                </div>
            </div>
        </div>

        <!-- ========== DETAIL VIEW ========== -->
        <div v-if="currentView === 'detail' && selectedApp" class="px-4 py-3">
            <div class="mb-4">
                <h1 class="text-xl font-bold mb-2">{{ selectedApp.title }}</h1>
                <span class="chip chip-lg" :class="'chip-' + selectedApp.status">{{ statusLabel(selectedApp.status) }}</span>
            </div>

            <!-- Spec -->
            <div class="card">
                <h3 class="text-xs font-bold uppercase mb-2" style="color: var(--tg-hint)">Spec</h3>
                <div class="spec-scroll text-sm leading-relaxed" style="color: var(--tg-text)">{{ selectedApp.spec }}</div>
            </div>

            <!-- Metadata -->
            <div class="card">
                <h3 class="text-xs font-bold uppercase mb-2" style="color: var(--tg-hint)">Details</h3>
                <div class="grid grid-cols-2 gap-y-2 text-sm">
                    <div style="color: var(--tg-hint)">Source</div><div>{{ selectedApp.source || '—' }}</div>
                    <div style="color: var(--tg-hint)">Price</div><div>{{ selectedApp.price || '—' }}</div>
                    <div style="color: var(--tg-hint)">Users</div><div>{{ selectedApp.users || '—' }}</div>
                    <div style="color: var(--tg-hint)">Build Days</div><div>{{ selectedApp.build_days || '—' }}</div>
                    <div style="color: var(--tg-hint)">Tier</div><div>{{ selectedApp.tier || '—' }}</div>
                    <div style="color: var(--tg-hint)">Priority</div><div>#{{ selectedApp.priority }}</div>
                </div>
            </div>

            <!-- Timestamps -->
            <div v-if="selectedApp.started_at || selectedApp.completed_at" class="card">
                <h3 class="text-xs font-bold uppercase mb-2" style="color: var(--tg-hint)">Timestamps</h3>
                <div class="grid grid-cols-2 gap-y-2 text-sm">
                    <div v-if="selectedApp.started_at" style="color: var(--tg-hint)">Started</div>
                    <div v-if="selectedApp.started_at">{{ formatDate(selectedApp.started_at) }}</div>
                    <div v-if="selectedApp.completed_at" style="color: var(--tg-hint)">Completed</div>
                    <div v-if="selectedApp.completed_at">{{ formatDate(selectedApp.completed_at) }}</div>
                </div>
            </div>

            <!-- Notes -->
            <div v-if="selectedApp.notes" class="card">
                <h3 class="text-xs font-bold uppercase mb-2" style="color: var(--tg-hint)">Notes</h3>
                <p class="text-sm">{{ selectedApp.notes }}</p>
            </div>

            <!-- Cost breakdown -->
            <div v-if="selectedApp.costs" class="card">
                <h3 class="text-xs font-bold uppercase mb-2" style="color: var(--tg-hint)">Cost Breakdown</h3>
                <div class="grid grid-cols-2 gap-y-2 text-sm">
                    <div style="color: var(--tg-hint)">Shared Infra</div>
                    <div>{{ (selectedApp.costs.shared_infra_used || []).join(', ') || 'None' }}</div>
                    <div style="color: var(--tg-hint)">App Services</div>
                    <div>{{ (selectedApp.costs.app_specific_services || []).join(', ') || 'None' }}</div>
                    <div style="color: var(--tg-hint)">Burn</div>
                    <div>${{ (selectedApp.costs.app_burn_rate_usd_per_month || 0).toFixed(2) }}/mo</div>
                    <div style="color: var(--tg-hint)">Revenue</div>
                    <div>${{ (selectedApp.costs.revenue_usd_per_month || 0).toFixed(2) }}/mo</div>
                    <div style="color: var(--tg-hint)">Net</div>
                    <div :class="(selectedApp.costs.net_usd_per_month || 0) < 0 ? 'text-red-400' : 'text-green-400'">
                        ${{ (selectedApp.costs.net_usd_per_month || 0).toFixed(2) }}/mo
                    </div>
                    <div style="color: var(--tg-hint)">Paying Users</div>
                    <div>{{ selectedApp.costs.paying_users || 0 }}</div>
                    <div style="color: var(--tg-hint)">Break-even</div>
                    <div>{{ selectedApp.costs.break_even_users || 0 }} users</div>
                </div>
            </div>

            <!-- Status action buttons -->
            <div class="flex flex-col gap-2 mt-4 mb-6">
                <button v-if="selectedApp.status === 'pending'" class="btn btn-primary w-full" @click="updateStatus('in_progress')">Start Build</button>
                <button v-if="selectedApp.status === 'in_progress'" class="btn btn-success w-full" @click="updateStatus('done')">Mark Done</button>
                <button v-if="selectedApp.status === 'in_progress'" class="btn btn-danger w-full" @click="updateStatus('blocked')">Mark Blocked</button>
                <button v-if="selectedApp.status === 'blocked'" class="btn btn-warning w-full" @click="updateStatus('pending')">Unblock</button>
                <button v-if="selectedApp.status === 'done'" class="btn btn-secondary w-full" @click="updateStatus('pending')">Reopen</button>
            </div>
        </div>

        <!-- ========== ADD VIEW ========== -->
        <div v-if="currentView === 'add'" class="px-4 py-3">
            <h1 class="text-xl font-bold mb-4">Add App</h1>
            <div class="flex flex-col gap-3">
                <div>
                    <label class="block text-xs font-bold uppercase mb-1" style="color: var(--tg-hint)">Title</label>
                    <input v-model="newApp.title" class="input-field" placeholder="My Awesome App">
                </div>
                <div>
                    <label class="block text-xs font-bold uppercase mb-1" style="color: var(--tg-hint)">Spec</label>
                    <textarea v-model="newApp.spec" class="input-field" placeholder="What does this app do?"></textarea>
                </div>
                <div class="grid grid-cols-2 gap-3">
                    <div>
                        <label class="block text-xs font-bold uppercase mb-1" style="color: var(--tg-hint)">Target Price</label>
                        <input v-model="newApp.price" class="input-field" placeholder="$9/mo">
                    </div>
                    <div>
                        <label class="block text-xs font-bold uppercase mb-1" style="color: var(--tg-hint)">Target Users</label>
                        <input v-model="newApp.users" class="input-field" placeholder="Freelancers, etc.">
                    </div>
                </div>
                <div class="grid grid-cols-2 gap-3">
                    <div>
                        <label class="block text-xs font-bold uppercase mb-1" style="color: var(--tg-hint)">Build Days</label>
                        <input v-model.number="newApp.build_days" type="number" class="input-field" placeholder="3">
                    </div>
                    <div>
                        <label class="block text-xs font-bold uppercase mb-1" style="color: var(--tg-hint)">Tier (1/2/3)</label>
                        <select v-model="newApp.tier" class="input-field">
                            <option value="1">Tier 1 — Frontend only</option>
                            <option value="2">Tier 2 — Shared backend</option>
                            <option value="3">Tier 3 — External APIs</option>
                        </select>
                    </div>
                </div>
                <div>
                    <label class="block text-xs font-bold uppercase mb-1" style="color: var(--tg-hint)">Priority Position</label>
                    <input v-model.number="newApp.priority" type="number" class="input-field" :placeholder="'Next: ' + nextPriority">
                </div>
                <button class="btn btn-primary w-full mt-2" @click="addApp" :disabled="!newApp.title || saving">
                    {{ saving ? 'Saving...' : 'Add to Queue' }}
                </button>
            </div>
        </div>

        <!-- ========== COSTS VIEW ========== -->
        <div v-if="currentView === 'costs'" class="px-4 py-3">
            <h1 class="text-xl font-bold mb-4">Costs</h1>

            <!-- Shared Infrastructure -->
            <h2 class="text-xs font-bold uppercase mb-2" style="color: var(--tg-hint)">Shared Infrastructure</h2>
            <div v-for="svc in sharedServices" :key="svc.name" class="card mb-2">
                <div class="flex items-center justify-between mb-1">
                    <span class="text-sm font-semibold">{{ svc.name }}</span>
                    <span v-if="svc.free_tier" class="badge-free">Free Tier</span>
                    <span v-else class="text-sm font-bold text-red-400">${{ svc.usd_per_month }}/mo</span>
                </div>
                <p class="text-xs mb-2" style="color: var(--tg-hint)">{{ svc.purpose }}</p>
                <div v-if="svc.free_tier_limit" class="text-xs mb-1" style="color: var(--tg-hint)">
                    Limit: {{ svc.free_tier_limit }}
                </div>
                <div class="text-xs" style="color: var(--tg-hint)">
                    Used by: {{ formatUsedBy(svc.used_by) }}
                </div>
                <div v-if="svc.upgrade_cost_usd_per_month > 0" class="text-xs mt-1 text-yellow-500">
                    Upgrade: ${{ svc.upgrade_cost_usd_per_month }}/mo — {{ svc.upgrade_trigger }}
                </div>
            </div>

            <!-- On-Demand Services -->
            <div v-if="onDemandServices.length" class="mt-4">
                <h2 class="text-xs font-bold uppercase mb-2" style="color: var(--tg-hint)">On-Demand Services</h2>
                <div v-for="svc in onDemandServices" :key="svc.name" class="card mb-2">
                    <div class="flex items-center justify-between mb-1">
                        <span class="text-sm font-semibold">{{ svc.name }}</span>
                        <span class="text-xs" style="color: var(--tg-hint)">~${{ svc.estimated_usd_per_1k_uses }}/1k uses</span>
                    </div>
                    <p class="text-xs mb-1" style="color: var(--tg-hint)">{{ svc.purpose }}</p>
                    <div class="text-xs" style="color: var(--tg-hint)">
                        Used by: {{ formatUsedBy(svc.used_by) }}
                    </div>
                </div>
            </div>

            <!-- Shared burn summary -->
            <div v-if="infraTotals" class="card mt-4" style="border-color: rgba(255,159,10,0.2)">
                <h3 class="text-xs font-bold uppercase mb-2" style="color: var(--tg-hint)">Shared Burn Summary</h3>
                <div class="grid grid-cols-2 gap-y-1 text-sm">
                    <div style="color: var(--tg-hint)">Current shared burn</div>
                    <div>${{ (infraTotals.shared_burn_rate_usd_per_month || 0).toFixed(2) }}/mo</div>
                    <div style="color: var(--tg-hint)">After free tier</div>
                    <div class="text-yellow-500">${{ (infraTotals.shared_burn_rate_after_free_tier_usd_per_month || 0).toFixed(2) }}/mo</div>
                </div>
            </div>

            <!-- Per-App Costs -->
            <h2 class="text-xs font-bold uppercase mt-6 mb-2" style="color: var(--tg-hint)">Per-App Costs</h2>
            <div v-for="app in appsWithCosts" :key="app.id" class="card mb-2">
                <div class="flex items-center justify-between mb-1">
                    <div class="flex items-center gap-2 min-w-0">
                        <span class="text-sm font-semibold truncate">{{ app.title }}</span>
                        <span class="chip chip-pending" :class="'chip-' + app.status" style="flex-shrink:0">{{ statusLabel(app.status) }}</span>
                    </div>
                    <span v-if="isBleeding(app)" class="badge-bleeding flex-shrink-0">Bleeding</span>
                </div>
                <div class="grid grid-cols-4 gap-1 text-xs mt-2">
                    <div class="text-center">
                        <div style="color: var(--tg-hint)">Burn</div>
                        <div class="font-semibold">${{ appBurn(app) }}</div>
                    </div>
                    <div class="text-center">
                        <div style="color: var(--tg-hint)">Revenue</div>
                        <div class="font-semibold">${{ appRevenue(app) }}</div>
                    </div>
                    <div class="text-center">
                        <div style="color: var(--tg-hint)">Net</div>
                        <div class="font-semibold" :class="appNetVal(app) < 0 ? 'text-red-400' : 'text-green-400'">${{ appNet(app) }}</div>
                    </div>
                    <div class="text-center">
                        <div style="color: var(--tg-hint)">Users</div>
                        <div class="font-semibold">{{ app.costs ? app.costs.paying_users || 0 : 0 }}</div>
                    </div>
                </div>
            </div>

            <!-- Apps without costs data -->
            <div v-if="appsWithoutCosts.length" class="text-xs mt-2 mb-4" style="color: var(--tg-hint)">
                {{ appsWithoutCosts.length }} app(s) have no cost data yet.
            </div>

            <!-- Portfolio Rollup -->
            <div class="card mt-4 mb-6" style="border-color: rgba(51,144,236,0.3)">
                <h3 class="text-xs font-bold uppercase mb-3" style="color: var(--tg-hint)">Portfolio Rollup</h3>
                <div class="grid grid-cols-2 gap-y-2 text-sm">
                    <div style="color: var(--tg-hint)">Shared burn</div>
                    <div>${{ portfolioRollup.sharedBurn.toFixed(2) }}/mo</div>
                    <div style="color: var(--tg-hint)">Per-app burn</div>
                    <div>${{ portfolioRollup.perAppBurn.toFixed(2) }}/mo</div>
                    <div class="font-bold">True total burn</div>
                    <div class="font-bold text-red-400">${{ portfolioRollup.totalBurn.toFixed(2) }}/mo</div>
                    <div style="color: var(--tg-hint)">Total revenue</div>
                    <div class="text-green-400">${{ portfolioRollup.totalRevenue.toFixed(2) }}/mo</div>
                    <div class="font-bold">Portfolio net</div>
                    <div class="font-bold" :class="portfolioRollup.portfolioNet < 0 ? 'text-red-400' : 'text-green-400'">
                        ${{ portfolioRollup.portfolioNet.toFixed(2) }}/mo
                    </div>
                    <div style="color: var(--tg-hint)">Bleeding apps</div>
                    <div>{{ portfolioRollup.bleedingCount }}</div>
                </div>
            </div>
        </div>

        <!-- ========== SETTINGS VIEW ========== -->
        <div v-if="currentView === 'settings'" class="px-4 py-3">
            <h1 class="text-xl font-bold mb-4">Settings</h1>
            <div class="card">
                <h3 class="text-xs font-bold uppercase mb-2" style="color: var(--tg-hint)">GitHub PAT</h3>
                <p class="text-sm mb-3" style="color: var(--tg-hint)">
                    {{ pat ? 'Token: ' + pat.slice(0, 7) + '...' + pat.slice(-4) : 'No token set' }}
                </p>
                <div class="mb-3">
                    <input v-model="patInput" type="password" class="input-field" placeholder="ghp_xxxxxxxxxxxx">
                </div>
                <div class="flex gap-2">
                    <button class="btn btn-primary flex-1" @click="validateAndSavePat" :disabled="patValidating">
                        {{ patValidating ? 'Validating...' : 'Update Token' }}
                    </button>
                    <button class="btn btn-danger" @click="clearPat">Clear</button>
                </div>
            </div>
            <div class="card mt-3">
                <h3 class="text-xs font-bold uppercase mb-2" style="color: var(--tg-hint)">Data</h3>
                <button class="btn btn-secondary w-full" @click="refreshData">Force Refresh</button>
            </div>
        </div>

        <!-- ========== BOTTOM NAV ========== -->
        <div v-if="currentView !== 'setup'" class="bottom-nav">
            <button class="nav-item" :class="{ active: currentView === 'dashboard' }" @click="navigateTo('dashboard')">
                <svg fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M4 6h16M4 12h16M4 18h16"/></svg>
                Queue
            </button>
            <button class="nav-item" :class="{ active: currentView === 'add' }" @click="navigateTo('add')">
                <svg fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M12 4v16m8-8H4"/></svg>
                Add
            </button>
            <button class="nav-item" :class="{ active: currentView === 'costs' }" @click="navigateTo('costs')">
                <svg fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M12 8c-1.657 0-3 .895-3 2s1.343 2 3 2 3 .895 3 2-1.343 2-3 2m0-8c1.11 0 2.08.402 2.599 1M12 8V7m0 1v8m0 0v1m0-1c-1.11 0-2.08-.402-2.599-1"/></svg>
                Costs
            </button>
        </div>
    </div>

    <script>
        const { createApp, ref, computed, watch, onMounted, onUnmounted, nextTick } = Vue;

        const tg = window.Telegram?.WebApp || {
            ready() {}, expand() {}, close() {},
            HapticFeedback: { impactOccurred() {}, notificationOccurred() {} },
            BackButton: { show() {}, hide() {}, onClick(cb) { this._cb = cb; }, offClick(cb) {} },
            themeParams: {},
            openTelegramLink(url) { window.open(url, '_blank'); }
        };

        createApp({
            setup() {
                // ── Constants ──
                const OWNER = 'melshid';
                const REPO = 'telegram-games';
                const QUEUE_PATH = 'queue.json';
                const INFRA_PATH = 'infrastructure.json';
                const POLL_INTERVAL = 30000;
                const STORAGE_KEY_PAT = 'queuepilot-pat';
                const STORAGE_KEY_QUEUE = 'queuepilot-queue-cache';
                const STORAGE_KEY_INFRA = 'queuepilot-infra-cache';

                // ── State ──
                const pat = ref(localStorage.getItem(STORAGE_KEY_PAT) || '');
                const patInput = ref('');
                const patValidating = ref(false);
                const currentView = ref(pat.value ? 'dashboard' : 'setup');
                const viewHistory = ref([]);

                const queueApps = ref([]);
                const infrastructure = ref(null);
                const queueSha = ref(null);
                const infraSha = ref(null);
                const lastRefresh = ref(null);
                const loading = ref(false);
                const saving = ref(false);
                const isOffline = ref(!navigator.onLine);

                const selectedApp = ref(null);
                const newApp = ref(freshNewApp());

                const toasts = ref([]);
                let toastId = 0;
                let pollTimer = null;
                let sortableInstance = null;
                const sortableList = ref(null);

                // Pull-to-refresh state
                const ptrPulling = ref(false);
                const ptrText = ref('Pull to refresh');

                // ── Computed ──
                const sortedApps = computed(() => {
                    return [...queueApps.value].sort((a, b) => a.priority - b.priority);
                });

                const buildingApp = computed(() => {
                    return queueApps.value.find(a => a.status === 'in_progress');
                });

                const nextPriority = computed(() => {
                    if (!queueApps.value.length) return 0;
                    return Math.max(...queueApps.value.map(a => a.priority)) + 1;
                });

                const lastRefreshText = computed(() => {
                    if (!lastRefresh.value) return 'Not yet synced';
                    const diff = Math.round((Date.now() - lastRefresh.value) / 1000);
                    if (diff < 5) return 'Just now';
                    if (diff < 60) return `${diff}s ago`;
                    return `${Math.floor(diff / 60)}m ago`;
                });

                // Infrastructure computed
                const sharedServices = computed(() => infrastructure.value?.shared_services || []);
                const onDemandServices = computed(() => infrastructure.value?.on_demand_services || []);
                const infraTotals = computed(() => infrastructure.value?.totals || null);

                // Cost computed
                const appsWithCosts = computed(() => queueApps.value.filter(a => a.costs));
                const appsWithoutCosts = computed(() => queueApps.value.filter(a => !a.costs));

                const portfolioRollup = computed(() => {
                    const sharedBurn = infraTotals.value?.shared_burn_rate_usd_per_month || 0;
                    let perAppBurn = 0;
                    let totalRevenue = 0;
                    let bleedingCount = 0;
                    for (const app of queueApps.value) {
                        if (app.costs) {
                            perAppBurn += app.costs.app_burn_rate_usd_per_month || 0;
                            totalRevenue += app.costs.revenue_usd_per_month || 0;
                            if (isBleeding(app)) bleedingCount++;
                        }
                    }
                    const totalBurn = sharedBurn + perAppBurn;
                    return { sharedBurn, perAppBurn, totalBurn, totalRevenue, portfolioNet: totalRevenue - totalBurn, bleedingCount };
                });

                // ── GitHub API ──
                async function ghFetch(url, options = {}) {
                    const headers = {
                        'Accept': 'application/vnd.github.v3+json',
                        'Authorization': `token ${pat.value}`,
                        ...options.headers
                    };
                    const res = await fetch(url, { ...options, headers });
                    if (!res.ok) {
                        const body = await res.text().catch(() => '');
                        throw { status: res.status, message: body };
                    }
                    return res.json();
                }

                async function fetchFile(path) {
                    const url = `https://api.github.com/repos/${OWNER}/${REPO}/contents/${path}`;
                    const data = await ghFetch(url);
                    const content = JSON.parse(atob(data.content));
                    return { content, sha: data.sha };
                }

                async function writeFile(path, content, sha, message) {
                    const url = `https://api.github.com/repos/${OWNER}/${REPO}/contents/${path}`;
                    const body = JSON.stringify({
                        message,
                        content: btoa(unescape(encodeURIComponent(JSON.stringify(content, null, 2) + '\n'))),
                        sha
                    });
                    return ghFetch(url, { method: 'PUT', body });
                }

                async function refreshData() {
                    if (loading.value) return;
                    loading.value = true;
                    try {
                        const [queueData, infraData] = await Promise.all([
                            fetchFile(QUEUE_PATH),
                            fetchFile(INFRA_PATH)
                        ]);
                        queueApps.value = queueData.content;
                        queueSha.value = queueData.sha;
                        infrastructure.value = infraData.content;
                        infraSha.value = infraData.sha;
                        lastRefresh.value = Date.now();

                        // Cache for offline
                        localStorage.setItem(STORAGE_KEY_QUEUE, JSON.stringify(queueData.content));
                        localStorage.setItem(STORAGE_KEY_INFRA, JSON.stringify(infraData.content));

                        isOffline.value = false;
                    } catch (err) {
                        if (!navigator.onLine) {
                            isOffline.value = true;
                            loadCachedData();
                        } else {
                            showToast('Failed to fetch data: ' + (err.message || err.status), 'error');
                        }
                    } finally {
                        loading.value = false;
                    }
                }

                function loadCachedData() {
                    try {
                        const q = localStorage.getItem(STORAGE_KEY_QUEUE);
                        const i = localStorage.getItem(STORAGE_KEY_INFRA);
                        if (q) queueApps.value = JSON.parse(q);
                        if (i) infrastructure.value = JSON.parse(i);
                    } catch (e) {
                        // Cache corrupt, ignore
                    }
                }

                async function saveQueue(message) {
                    if (saving.value) return;
                    saving.value = true;
                    try {
                        const result = await writeFile(QUEUE_PATH, queueApps.value, queueSha.value, message || 'QueuePilot: update queue');
                        queueSha.value = result.content.sha;
                        showToast('Saved', 'success');
                    } catch (err) {
                        if (err.status === 409) {
                            await handleConflict();
                        } else {
                            showToast('Save failed: ' + (err.message || err.status), 'error');
                        }
                    } finally {
                        saving.value = false;
                    }
                }

                async function saveInfra(message) {
                    if (saving.value) return;
                    saving.value = true;
                    try {
                        const result = await writeFile(INFRA_PATH, infrastructure.value, infraSha.value, message || 'QueuePilot: update infrastructure');
                        infraSha.value = result.content.sha;
                    } catch (err) {
                        showToast('Infra save failed: ' + (err.message || err.status), 'error');
                    } finally {
                        saving.value = false;
                    }
                }

                async function handleConflict() {
                    showToast('Conflict detected — merging...', 'info');
                    try {
                        const fresh = await fetchFile(QUEUE_PATH);
                        // Merge: Dave's ordering wins, remote status/timestamp changes win
                        const localOrder = queueApps.value.map(a => a.id);
                        const merged = localOrder.map(id => {
                            const remote = fresh.content.find(a => a.id === id);
                            const local = queueApps.value.find(a => a.id === id);
                            if (!remote) return local; // new local app
                            // Remote status/timestamps win; local priority wins
                            return { ...local, status: remote.status, started_at: remote.started_at, completed_at: remote.completed_at, notes: remote.notes, priority: local.priority };
                        });
                        // Add any apps that exist remotely but not locally
                        for (const remote of fresh.content) {
                            if (!merged.find(a => a.id === remote.id)) {
                                merged.push(remote);
                            }
                        }
                        queueApps.value = merged;
                        queueSha.value = fresh.sha;
                        // Retry write
                        const result = await writeFile(QUEUE_PATH, queueApps.value, queueSha.value, 'QueuePilot: merge conflict resolution');
                        queueSha.value = result.content.sha;
                        showToast('Conflict resolved', 'success');
                    } catch (retryErr) {
                        showToast('Merge failed — please refresh', 'error');
                    }
                }

                function startPolling() {
                    stopPolling();
                    pollTimer = setInterval(refreshData, POLL_INTERVAL);
                }

                function stopPolling() {
                    if (pollTimer) { clearInterval(pollTimer); pollTimer = null; }
                }

                // ── Navigation ──
                function navigateTo(view) {
                    if (currentView.value !== 'setup') {
                        viewHistory.value.push(currentView.value);
                    }
                    currentView.value = view;
                    updateBackButton();
                    tg.HapticFeedback.impactOccurred('light');
                }

                function goBack() {
                    if (viewHistory.value.length) {
                        currentView.value = viewHistory.value.pop();
                    } else {
                        currentView.value = 'dashboard';
                    }
                    updateBackButton();
                }

                function updateBackButton() {
                    if (currentView.value === 'dashboard' || currentView.value === 'setup') {
                        tg.BackButton.hide();
                    } else {
                        tg.BackButton.show();
                    }
                }

                // ── Queue Operations ──
                function openDetail(app) {
                    selectedApp.value = app;
                    navigateTo('detail');
                }

                async function updateStatus(newStatus) {
                    const app = queueApps.value.find(a => a.id === selectedApp.value.id);
                    if (!app) return;
                    app.status = newStatus;
                    if (newStatus === 'in_progress' && !app.started_at) {
                        app.started_at = new Date().toISOString();
                    }
                    if (newStatus === 'done' && !app.completed_at) {
                        app.completed_at = new Date().toISOString();
                    }
                    selectedApp.value = app;
                    tg.HapticFeedback.notificationOccurred('success');
                    await saveQueue(`QueuePilot: ${app.name} → ${newStatus}`);
                }

                async function addApp() {
                    const app = {
                        id: nextId(),
                        status: 'pending',
                        name: slugify(newApp.value.title),
                        title: newApp.value.title,
                        source: 'QueuePilot',
                        spec: newApp.value.spec,
                        price: newApp.value.price,
                        users: newApp.value.users,
                        build_days: newApp.value.build_days || 3,
                        priority: newApp.value.priority ?? nextPriority.value,
                        tier: newApp.value.tier || '1'
                    };
                    queueApps.value.push(app);
                    tg.HapticFeedback.notificationOccurred('success');
                    await saveQueue(`QueuePilot: add ${app.name}`);
                    newApp.value = freshNewApp();
                    navigateTo('dashboard');
                }

                function nextId() {
                    if (!queueApps.value.length) return 0;
                    return Math.max(...queueApps.value.map(a => a.id)) + 1;
                }

                function slugify(text) {
                    return (text || 'untitled').toLowerCase().replace(/[^a-z0-9]+/g, '-').replace(/^-|-$/g, '').slice(0, 40);
                }

                function freshNewApp() {
                    return { title: '', spec: '', price: '', users: '', build_days: 3, tier: '1', priority: null };
                }

                // Debounced save for reorder
                let reorderTimeout = null;
                function debouncedSaveReorder() {
                    clearTimeout(reorderTimeout);
                    reorderTimeout = setTimeout(() => {
                        saveQueue('QueuePilot: reorder queue');
                    }, 1500);
                }

                // ── Cost Helpers ──
                function isBleeding(app) {
                    return app.costs && (app.costs.app_burn_rate_usd_per_month || 0) > 0 && (app.costs.paying_users || 0) === 0;
                }
                function appBurn(app) { return (app.costs?.app_burn_rate_usd_per_month || 0).toFixed(2); }
                function appRevenue(app) { return (app.costs?.revenue_usd_per_month || 0).toFixed(2); }
                function appNetVal(app) { return (app.costs?.net_usd_per_month || 0); }
                function appNet(app) { return appNetVal(app).toFixed(2); }

                // ── UI Helpers ──
                function statusLabel(status) {
                    const labels = { pending: 'Pending', in_progress: 'Building', done: 'Done', blocked: 'Blocked' };
                    return labels[status] || status;
                }

                function formatDate(iso) {
                    if (!iso) return '—';
                    try { return new Date(iso).toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' }); }
                    catch { return iso; }
                }

                function formatUsedBy(arr) {
                    if (!arr || !arr.length) return 'None';
                    if (arr.includes('all')) return 'All apps';
                    return arr.join(', ');
                }

                function showToast(message, type = 'info') {
                    const id = ++toastId;
                    toasts.value.push({ id, message, type });
                    setTimeout(() => {
                        toasts.value = toasts.value.filter(t => t.id !== id);
                    }, 3000);
                }

                // ── PAT Management ──
                async function validateAndSavePat() {
                    if (!patInput.value.trim()) {
                        showToast('Please enter a token', 'error');
                        return;
                    }
                    patValidating.value = true;
                    try {
                        const res = await fetch(`https://api.github.com/repos/${OWNER}/${REPO}`, {
                            headers: { 'Authorization': `token ${patInput.value.trim()}`, 'Accept': 'application/vnd.github.v3+json' }
                        });
                        if (!res.ok) throw new Error('Invalid token or no access');
                        pat.value = patInput.value.trim();
                        localStorage.setItem(STORAGE_KEY_PAT, pat.value);
                        patInput.value = '';
                        showToast('Connected!', 'success');
                        if (currentView.value === 'setup') {
                            currentView.value = 'dashboard';
                            refreshData();
                            startPolling();
                        }
                    } catch (err) {
                        showToast('Token validation failed: ' + err.message, 'error');
                    } finally {
                        patValidating.value = false;
                    }
                }

                function clearPat() {
                    pat.value = '';
                    localStorage.removeItem(STORAGE_KEY_PAT);
                    currentView.value = 'setup';
                    stopPolling();
                    tg.HapticFeedback.notificationOccurred('warning');
                    showToast('Token cleared', 'info');
                }

                // ── Pull to Refresh ──
                let ptrStartY = 0;
                function onTouchStart(e) {
                    if (currentView.value !== 'dashboard') return;
                    if (window.scrollY === 0) {
                        ptrStartY = e.touches[0].clientY;
                    }
                }
                function onTouchMove(e) {
                    if (!ptrStartY || currentView.value !== 'dashboard') return;
                    const dy = e.touches[0].clientY - ptrStartY;
                    if (dy > 40 && window.scrollY === 0) {
                        ptrPulling.value = true;
                        ptrText.value = dy > 100 ? 'Release to refresh' : 'Pull to refresh';
                    }
                }
                function onTouchEnd() {
                    if (ptrPulling.value && ptrText.value === 'Release to refresh') {
                        ptrText.value = 'Refreshing...';
                        refreshData().then(() => {
                            ptrPulling.value = false;
                        });
                    } else {
                        ptrPulling.value = false;
                    }
                    ptrStartY = 0;
                }

                // ── SortableJS init ──
                function initSortable() {
                    nextTick(() => {
                        if (sortableInstance) sortableInstance.destroy();
                        const el = sortableList.value;
                        if (!el) return;
                        sortableInstance = new Sortable(el, {
                            handle: '.drag-handle',
                            animation: 200,
                            ghostClass: 'sortable-ghost',
                            chosenClass: 'sortable-chosen',
                            onEnd(evt) {
                                // Reorder the array based on new DOM order
                                const ids = Array.from(el.children).map(c => parseInt(c.dataset.id));
                                const ordered = ids.map(id => queueApps.value.find(a => a.id === id)).filter(Boolean);
                                ordered.forEach((app, i) => { app.priority = i; });
                                queueApps.value = ordered;
                                tg.HapticFeedback.impactOccurred('medium');
                                debouncedSaveReorder();
                            }
                        });
                    });
                }

                // Re-init sortable when switching to dashboard
                watch(currentView, (v) => {
                    if (v === 'dashboard') initSortable();
                });

                // ── Visibility change ──
                function onVisibilityChange() {
                    if (document.visibilityState === 'visible' && pat.value) {
                        refreshData();
                    }
                }

                // ── Lifecycle ──
                onMounted(() => {
                    tg.ready();
                    tg.expand();
                    tg.BackButton.onClick(goBack);

                    document.addEventListener('touchstart', onTouchStart, { passive: true });
                    document.addEventListener('touchmove', onTouchMove, { passive: true });
                    document.addEventListener('touchend', onTouchEnd);
                    document.addEventListener('visibilitychange', onVisibilityChange);
                    window.addEventListener('online', () => { isOffline.value = false; refreshData(); });
                    window.addEventListener('offline', () => { isOffline.value = true; });

                    if (pat.value) {
                        refreshData().then(initSortable);
                        startPolling();
                    }
                });

                onUnmounted(() => {
                    stopPolling();
                    if (sortableInstance) sortableInstance.destroy();
                    document.removeEventListener('touchstart', onTouchStart);
                    document.removeEventListener('touchmove', onTouchMove);
                    document.removeEventListener('touchend', onTouchEnd);
                    document.removeEventListener('visibilitychange', onVisibilityChange);
                    tg.BackButton.offClick(goBack);
                });

                return {
                    // State
                    pat, patInput, patValidating, currentView, loading, saving, isOffline,
                    queueApps, infrastructure, selectedApp, newApp, toasts, sortableList,
                    lastRefresh, ptrPulling, ptrText,
                    // Computed
                    sortedApps, buildingApp, nextPriority, lastRefreshText,
                    sharedServices, onDemandServices, infraTotals,
                    appsWithCosts, appsWithoutCosts, portfolioRollup,
                    // Methods
                    navigateTo, goBack, openDetail, updateStatus, addApp,
                    validateAndSavePat, clearPat, refreshData,
                    statusLabel, formatDate, formatUsedBy, showToast,
                    isBleeding, appBurn, appRevenue, appNet, appNetVal
                };
            }
        }).mount('#app');
    </script>
</body>
</html>
